<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EIP-712 Signature Debug Tool - PMM Protocol</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.9.0/ethers.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>EIP-712 Signature Debug Tool</h1>
            <p class="subtitle">OnChain Labs PMM Protocol</p>
        </header>

        <main>
            <!-- Input Section -->
            <section class="panel input-panel">
                <h2>Input</h2>
                
                <div class="form-group">
                    <label for="jsonInput">Order JSON</label>
                    <textarea id="jsonInput" placeholder='{
  "chainId": 42161,
  "verifyingContract": "auto from chainId",
  "order": {
    "rfqId": "123456",
    "expiry": 1234567890,
    "makerAsset": "0x...",
    "takerAsset": "0x...",
    "makerAddress": "auto from privateKey",
    "makerAmount": "100",
    "takerAmount": "90",
    "usePermit2": true,
    "permit2Signature": "TO_BE_SIGNED",
    "permit2Witness": "TO_BE_CALCULATED",
    "permit2WitnessType": "TO_BE_GENERATED"
  },
  "privateKey": "0x...",
  "permit2DomainSeparator": "0x8a6e6e19...",
  "witnessStruct": {
    "name": "YourWitness",
    "fields": [
      { "type": "address", "name": "user" },
      { "type": "uint256", "name": "amount" }
    ],
    "values": {
      "user": "0x...",
      "amount": "100"
    }
  }
}'></textarea>
                </div>


                <div class="button-group">
                    <button id="generateBtn" class="btn btn-primary">Generate Signature</button>
                    <button id="clearBtn" class="btn btn-secondary">Clear</button>
                </div>
                
                <div class="example-section">
                    <label>Load Example</label>
                    <div class="example-buttons">
                        <button id="loadExample1Btn" class="btn btn-example">Order 1<br><small>usePermit2: false</small></button>
                        <button id="loadExample2Btn" class="btn btn-example">Order 2<br><small>usePermit2: true, no witness</small></button>
                        <button id="loadExample3Btn" class="btn btn-example">Order 3<br><small>witnessStruct: ExampleWitness</small></button>
                        <button id="loadExample4Btn" class="btn btn-example">Order 4<br><small>witnessStruct: Consideration</small></button>
                    </div>
                </div>
                
                <div class="info-box">
                    <h4>Auto-fill Features</h4>
                    <ul>
                        <li><strong>verifyingContract</strong>: Auto-filled from chainId</li>
                        <li><strong>makerAddress</strong>: Auto-derived from privateKey</li>
                        <li><strong>permit2WitnessType</strong>: Auto-generated from <code>witnessStruct</code> (EIP-712 alphabetical order)</li>
                        <li><strong>permit2Witness</strong>: Auto-calculated from <code>witnessStruct</code></li>
                    </ul>
                    <h4>witnessStruct Format (Order 3/4)</h4>
                    <pre class="code-example">// ExampleWitness(address user)
"witnessStruct": {
  "name": "ExampleWitness",
  "fields": [{ "type": "address", "name": "user" }],
  "values": { "user": "0x..." }
}

// Consideration(address token, uint256 amount, address counterparty)
"witnessStruct": {
  "name": "Consideration",
  "fields": [
    { "type": "address", "name": "token" },
    { "type": "uint256", "name": "amount" },
    { "type": "address", "name": "counterparty" }
  ],
  "values": { "token": "0x...", "amount": "100", "counterparty": "0x..." }
}</pre>
                </div>
            </section>

            <!-- Output Section -->
            <section class="panel output-panel">
                <h2>Output</h2>
                <p class="output-note">Verification order: structData -> structHash -> domainSeparator -> digest -> signature</p>

                <div id="errorDisplay" class="error-display hidden"></div>

                <!-- 0. Full Order -->
                <div class="output-group full-order-group">
                    <div class="output-header">
                        <label>Full Order <span class="hint">(with auto-filled values)</span></label>
                        <button class="copy-btn" data-target="fullOrderOutput">Copy</button>
                    </div>
                    <pre id="fullOrderOutput" class="output-value mono full-order">-</pre>
                </div>

                <!-- 1. Struct Data -->
                <div class="output-group">
                    <div class="output-header">
                        <label>1. structData <span class="hint">(ABI-encoded before keccak)</span></label>
                        <button class="copy-btn" data-target="structDataOutput">Copy</button>
                    </div>
                    <div id="structDataOutput" class="output-value mono">-</div>
                </div>

                <!-- 2. Struct Hash -->
                <div class="output-group">
                    <div class="output-header">
                        <label>2. structHash <span class="hint">(bytes32)</span></label>
                        <button class="copy-btn" data-target="structHashOutput">Copy</button>
                    </div>
                    <div id="structHashOutput" class="output-value mono">-</div>
                </div>

                <!-- 3. Domain Separator -->
                <div class="output-group">
                    <div class="output-header">
                        <label>3. domainSeparator <span class="hint">(bytes32)</span></label>
                        <button class="copy-btn" data-target="domainSeparatorOutput">Copy</button>
                    </div>
                    <div id="domainSeparatorOutput" class="output-value mono">-</div>
                </div>

                <!-- 4. Digest -->
                <div class="output-group">
                    <div class="output-header">
                        <label>4. digest <span class="hint">(EIP-712 final hash)</span></label>
                        <button class="copy-btn" data-target="digestOutput">Copy</button>
                    </div>
                    <div id="digestOutput" class="output-value mono">-</div>
                </div>

                <!-- 5. Signature -->
                <div class="output-group">
                    <div class="output-header">
                        <label>5. signature <span class="hint">(65 bytes)</span></label>
                        <button class="copy-btn" data-target="signatureOutput">Copy</button>
                    </div>
                    <div id="signatureOutput" class="output-value mono">-</div>
                    <div class="signature-breakdown">
                        <div class="sig-part">
                            <span class="sig-label">r:</span>
                            <span id="sigR" class="mono">-</span>
                        </div>
                        <div class="sig-part">
                            <span class="sig-label">s:</span>
                            <span id="sigS" class="mono">-</span>
                        </div>
                        <div class="sig-part">
                            <span class="sig-label">v:</span>
                            <span id="sigV" class="mono">-</span>
                        </div>
                    </div>
                </div>

                <!-- 6. Permit2 Section -->
                <div class="output-group permit2-section">
                    <h3>Permit2 Details</h3>
                    
                    <div class="output-subgroup">
                        <div class="output-header">
                            <label>permit2Witness <span class="hint">(bytes32)</span></label>
                            <button class="copy-btn" data-target="permit2WitnessOutput">Copy</button>
                        </div>
                        <div id="permit2WitnessOutput" class="output-value mono">-</div>
                    </div>

                    <div class="output-subgroup">
                        <div class="output-header">
                            <label>permit2WitnessType <span class="hint">(string)</span></label>
                            <button class="copy-btn" data-target="permit2WitnessTypeOutput">Copy</button>
                        </div>
                        <div id="permit2WitnessTypeOutput" class="output-value mono">-</div>
                    </div>

                    <div class="output-subgroup">
                        <div class="output-header">
                            <label>permit2Signature <span class="hint">(65 bytes)</span></label>
                            <button class="copy-btn" data-target="permit2SignatureOutput">Copy</button>
                        </div>
                        <div id="permit2SignatureOutput" class="output-value mono">-</div>
                        <div class="signature-breakdown">
                            <div class="sig-part">
                                <span class="sig-label">r:</span>
                                <span id="permit2SigR" class="mono">-</span>
                            </div>
                            <div class="sig-part">
                                <span class="sig-label">s:</span>
                                <span id="permit2SigS" class="mono">-</span>
                            </div>
                            <div class="sig-part">
                                <span class="sig-label">v:</span>
                                <span id="permit2SigV" class="mono">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Additional Debug Info -->
                <div class="output-group collapsible">
                    <button class="collapsible-header" onclick="toggleCollapsible(this)">
                        <span>Additional Debug Info</span>
                        <span class="chevron">â–¼</span>
                    </button>
                    <div class="collapsible-content">
                        <div class="output-subgroup">
                            <label>Chain</label>
                            <div id="chainNameOutput" class="output-value mono">-</div>
                        </div>
                        <div class="output-subgroup">
                            <label>Contract Address</label>
                            <div id="contractAddressOutput" class="output-value mono">-</div>
                        </div>
                        <div class="output-subgroup">
                            <label>Order TypeHash</label>
                            <div id="typeHashOutput" class="output-value mono">-</div>
                        </div>
                        <div class="output-subgroup">
                            <label>Domain TypeHash</label>
                            <div id="domainTypeHashOutput" class="output-value mono">-</div>
                        </div>
                        <div class="output-subgroup">
                            <label>Signer Address</label>
                            <div id="signerAddressOutput" class="output-value mono">-</div>
                        </div>
                        <div class="output-subgroup">
                            <label>Recovered Address</label>
                            <div id="recoveredAddressOutput" class="output-value mono">-</div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer>
            <p>OnChain Labs PMM Protocol - EIP-712 Debug Tool</p>
            <p class="version">Contract Version: 1.0</p>
            <p class="deployed-info">
                Deployed: Ethereum (0x0bdf..bb6) | Arbitrum (0x1ef0..896) | Base (0xed97..a5) | BNB (0x9ff5..a3)
            </p>
        </footer>
    </div>

    <script src="app.js?v=3"></script>
</body>
</html>
